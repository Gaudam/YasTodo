<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Mijn Bujo</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Patrick+Hand&display=swap" rel="stylesheet">
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        body {
            font-family: 'Patrick Hand', cursive;
            overscroll-behavior-y: none;
            background-color: #0F172A;
            color: #F1F5F9;
        }

        .dot-grid {
            background-image: radial-gradient(#475569 1.5px, transparent 1.5px);
            background-size: 24px 24px;
        }

        /* Hide scrollbar */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        input[type="date"] {
            color-scheme: dark;
        }

        /* --- CRUCIAL FIX FOR CALENDAR BUTTON --- */
        input[type="date"]::-webkit-calendar-picker-indicator {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            margin: 0;
            padding: 0;
            cursor: pointer;
            opacity: 0;
        }

        /* Animations */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(5px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in {
            animation: fadeIn 0.3s ease-out forwards;
        }
    </style>
</head>
<body class="h-[100dvh] w-full flex flex-col overflow-hidden selection:bg-blue-500 selection:text-white">

    <!-- Legend Modal -->
    <div id="legend-modal" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-50 flex items-center justify-center p-4 hidden">
        <div class="bg-[#1E293B] border border-slate-600 p-6 rounded-2xl max-w-sm w-full shadow-2xl animate-fade-in">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold text-white">Legenda</h3>
                <button onclick="toggleLegend(false)" class="text-slate-400 hover:text-white"><i data-lucide="x"></i></button>
            </div>
            <div class="space-y-4">
                <div class="flex items-center gap-3">
                    <div class="w-8 h-8 flex items-center justify-center bg-slate-800 rounded-full text-blue-200"><div class="w-2 h-2 rounded-full bg-blue-200"></div></div>
                    <div><p class="font-bold text-white">Taak</p><p class="text-sm text-slate-400">Iets wat je moet doen.</p></div>
                </div>
                <div class="flex items-center gap-3">
                    <div class="w-8 h-8 flex items-center justify-center bg-slate-800 rounded-full text-green-400"><i data-lucide="x" class="w-5 h-5"></i></div>
                    <div><p class="font-bold text-white">Voltooid</p><p class="text-sm text-slate-400">Taak is klaar.</p></div>
                </div>
                <div class="flex items-center gap-3">
                    <div class="w-8 h-8 flex items-center justify-center bg-slate-800 rounded-full text-blue-200"><i data-lucide="circle" class="w-4 h-4"></i></div>
                    <div><p class="font-bold text-white">Evenement</p><p class="text-sm text-slate-400">Afspraak of gebeurtenis.</p></div>
                </div>
                <div class="flex items-center gap-3">
                    <div class="w-8 h-8 flex items-center justify-center bg-slate-800 rounded-full text-blue-200"><i data-lucide="minus" class="w-4 h-4"></i></div>
                    <div><p class="font-bold text-white">Notitie</p><p class="text-sm text-slate-400">Gedachte, feit of idee.</p></div>
                </div>
                <div class="flex items-center gap-3">
                    <div class="w-8 h-8 flex items-center justify-center bg-slate-800 rounded-full text-purple-400"><i data-lucide="chevron-right" class="w-5 h-5"></i></div>
                    <div><p class="font-bold text-white">Gemigreerd</p><p class="text-sm text-slate-400">Verplaatst naar later.</p></div>
                </div>
            </div>
            <button onclick="toggleLegend(false)" class="mt-6 w-full py-3 bg-blue-600 hover:bg-blue-500 text-white rounded-xl font-bold">Begrepen</button>
        </div>
    </div>

    <!-- Main Container -->
    <div class="max-w-2xl mx-auto w-full h-full flex flex-col relative shadow-2xl bg-[#1E293B]/95 dot-grid border-x border-slate-700">
        
        <!-- Header -->
        <header class="pt-4 pb-2 px-4 bg-[#0F172A]/95 backdrop-blur-sm border-b border-slate-700 shrink-0 z-20">
            <div class="flex justify-between items-center mb-3">
                <div>
                    <div class="flex items-center gap-2">
                        <h1 class="text-3xl font-bold tracking-wide text-blue-100">Mijn Bujo</h1>
                        <button onclick="toggleLegend(true)" class="p-1 text-slate-400 hover:text-white rounded-full border border-slate-600 hover:bg-slate-700 transition-colors">
                            <i data-lucide="info" class="w-4 h-4"></i>
                        </button>
                    </div>
                    <p class="text-sm text-slate-400 mt-1 uppercase tracking-widest flex items-center gap-2">
                        <span class="flex items-center gap-1 text-blue-400 bg-blue-900/30 px-2 py-0.5 rounded-full text-[10px] font-bold border border-blue-800">
                            <i data-lucide="hard-drive" class="w-3 h-3"></i> Local Storage
                        </span>
                    </p>
                </div>
                <div class="text-right flex flex-col items-end">
                    <span id="progress-text" class="text-2xl font-bold text-blue-100">0%</span>
                    <div class="w-16 h-1.5 bg-slate-700 rounded-full mt-1 overflow-hidden">
                        <div id="progress-bar" class="h-full bg-blue-500 transition-all duration-500" style="width: 0%"></div>
                    </div>
                </div>
            </div>
            
            <!-- Filter & Sort Controls Row 1 -->
            <div class="flex justify-between items-center gap-2 mb-2">
                <div class="flex bg-slate-800 rounded-lg p-1">
                    <button id="btn-status-all" onclick="setFilterStatus('all')" class="px-3 py-1 rounded-md text-sm transition-colors bg-blue-600 text-white shadow">Alles</button>
                    <button id="btn-status-todo" onclick="setFilterStatus('todo')" class="px-3 py-1 rounded-md text-sm transition-colors text-slate-400 hover:text-slate-200">Open</button>
                </div>

                <!-- Sort Toggle -->
                <div class="flex bg-slate-800 rounded-lg p-1">
                    <button id="btn-sort-date" onclick="setSortMode('date')" class="p-1.5 rounded-md transition-colors text-slate-400 hover:text-white" title="Sorteer op Datum">
                        <i data-lucide="calendar-days" class="w-4 h-4"></i>
                    </button>
                    <button id="btn-sort-priority" onclick="setSortMode('priority')" class="p-1.5 rounded-md transition-colors text-yellow-400 bg-slate-700 shadow" title="Sorteer op Favorieten">
                        <i data-lucide="star" class="w-4 h-4 fill-current"></i>
                    </button>
                </div>
            </div>

            <!-- Type Filter Row 2 -->
            <div class="flex gap-2 overflow-x-auto no-scrollbar pb-1">
                <button id="btn-type-all" onclick="setFilterType('all')" class="flex items-center gap-1 px-3 py-1.5 rounded-lg text-xs font-bold uppercase tracking-wider bg-blue-900/40 text-blue-200 border border-blue-700/50 whitespace-nowrap">
                    <i data-lucide="layers" class="w-3 h-3"></i> Alles
                </button>
                <button id="btn-type-task" onclick="setFilterType('task')" class="flex items-center gap-1 px-3 py-1.5 rounded-lg text-xs font-bold uppercase tracking-wider bg-slate-800 text-slate-400 border border-slate-700 hover:bg-slate-700 whitespace-nowrap">
                    <div class="w-2 h-2 rounded-full bg-blue-400"></div> Taken
                </button>
                <button id="btn-type-event" onclick="setFilterType('event')" class="flex items-center gap-1 px-3 py-1.5 rounded-lg text-xs font-bold uppercase tracking-wider bg-slate-800 text-slate-400 border border-slate-700 hover:bg-slate-700 whitespace-nowrap">
                    <i data-lucide="circle" class="w-3 h-3"></i> Events
                </button>
                <button id="btn-type-note" onclick="setFilterType('note')" class="flex items-center gap-1 px-3 py-1.5 rounded-lg text-xs font-bold uppercase tracking-wider bg-slate-800 text-slate-400 border border-slate-700 hover:bg-slate-700 whitespace-nowrap">
                    <i data-lucide="minus" class="w-3 h-3"></i> Notities
                </button>
            </div>
        </header>

        <!-- Content List -->
        <div id="content-area" class="flex-1 overflow-y-auto overflow-x-hidden p-4 scroll-smooth no-scrollbar relative">
            <!-- Empty State -->
            <div id="empty-state" class="hidden flex-col items-center justify-center h-60 text-slate-500 text-center px-4">
                <div class="w-16 h-16 bg-slate-800 rounded-full flex items-center justify-center mb-4 text-slate-600">
                    <i data-lucide="filter-x" class="w-8 h-8"></i>
                </div>
                <p class="text-xl mb-1 text-slate-300">Geen items gevonden.</p>
                <p class="text-sm">Pas je filters aan of voeg iets toe.</p>
            </div>

            <!-- Entries List Container -->
            <div id="entries-list" class="space-y-1 pb-24 hidden"></div>
        </div>

        <!-- Input Area -->
        <div class="bg-[#0F172A] border-t border-slate-700 z-30 shrink-0 pb-safe">
            <form id="add-form" class="flex flex-col p-4 gap-3">
                <!-- Type Selector -->
                <div class="flex bg-slate-800 p-1 rounded-xl">
                    <label class="flex-1 cursor-pointer">
                        <input type="radio" name="entryType" value="task" checked class="hidden peer" onchange="updateTypeSelection()">
                        <div class="flex items-center justify-center gap-2 py-2 rounded-lg transition-all peer-checked:bg-[#1E293B] peer-checked:shadow peer-checked:text-blue-200 peer-checked:ring-1 peer-checked:ring-slate-600 text-slate-500">
                            <div class="w-2 h-2 rounded-full peer-checked:bg-blue-200 bg-slate-500"></div>
                            <span class="font-bold text-sm">Taak</span>
                        </div>
                    </label>
                    <label class="flex-1 cursor-pointer">
                        <input type="radio" name="entryType" value="event" class="hidden peer" onchange="updateTypeSelection()">
                        <div class="flex items-center justify-center gap-2 py-2 rounded-lg transition-all peer-checked:bg-[#1E293B] peer-checked:shadow peer-checked:text-blue-200 peer-checked:ring-1 peer-checked:ring-slate-600 text-slate-500">
                            <i data-lucide="circle" class="w-3 h-3"></i>
                            <span class="font-bold text-sm">Event</span>
                        </div>
                    </label>
                    <label class="flex-1 cursor-pointer">
                        <input type="radio" name="entryType" value="note" class="hidden peer" onchange="updateTypeSelection()">
                        <div class="flex items-center justify-center gap-2 py-2 rounded-lg transition-all peer-checked:bg-[#1E293B] peer-checked:shadow peer-checked:text-blue-200 peer-checked:ring-1 peer-checked:ring-slate-600 text-slate-500">
                            <i data-lucide="minus" class="w-3 h-3"></i>
                            <span class="font-bold text-sm">Notitie</span>
                        </div>
                    </label>
                </div>

                <div class="flex gap-2">
                    <div class="relative flex-1">
                        <input type="text" id="input-text" placeholder="Typ hier..." class="w-full pl-4 pr-4 py-3.5 text-lg bg-[#1E293B] border border-slate-600 rounded-xl focus:border-blue-500 focus:outline-none text-white placeholder:text-slate-500">
                    </div>
                    
                    <!-- Calendar Button -->
                    <div class="relative w-14 bg-[#1E293B] border border-slate-600 rounded-xl flex items-center justify-center text-slate-400 hover:text-white hover:border-slate-500 transition-colors cursor-pointer group">
                        <i data-lucide="calendar" class="w-6 h-6 group-hover:scale-110 transition-transform pointer-events-none relative z-0"></i>
                        <!-- The input is absolutely positioned and has high Z-index to catch ALL clicks -->
                        <input type="date" id="input-date" class="absolute inset-0 w-full h-full opacity-0 z-50 cursor-pointer">
                    </div>

                    <button type="submit" id="btn-submit" disabled class="w-14 bg-blue-600 text-white rounded-xl flex items-center justify-center hover:bg-blue-500 disabled:opacity-30 disabled:hover:bg-blue-600 active:scale-95 transition-all">
                        <i data-lucide="plus" class="w-7 h-7"></i>
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Application Script -->
    <script>
        // --- State Management ---
        const state = {
            entries: [],
            filterStatus: 'all', // 'all' | 'todo'
            filterType: 'all',   // 'all' | 'task' | 'event' | 'note'
            sortMode: 'priority', // 'priority' | 'date'
            editingId: null,
            // Edit form state
            editForm: {
                text: '',
                date: '',
                type: 'task'
            }
        };

        const STORAGE_KEY = 'bujo_entries_v1';

        // --- Data Persistence ---
        function saveData() {
            try {
                localStorage.setItem(STORAGE_KEY, JSON.stringify(state.entries));
                renderStats(); 
            } catch (e) {
                console.error("Kon niet opslaan:", e);
                alert("Let op: opslag is vol of geblokkeerd.");
            }
        }

        function loadData() {
            try {
                const raw = localStorage.getItem(STORAGE_KEY);
                if (raw) {
                    const parsed = JSON.parse(raw);
                    state.entries = parsed.map(entry => ({
                        ...entry,
                        targetDate: new Date(entry.targetDate),
                        createdAt: new Date(entry.createdAt)
                    }));
                }
            } catch (e) {
                console.error("Kon data niet laden:", e);
                state.entries = [];
            }
        }

        function refreshIcons() {
            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
            }
        }

        // --- Helper Functions ---
        const dateToInputString = (date) => {
            return date.toISOString().split('T')[0];
        };

        // NEW: Date formatter with Year
        const formatEntryDate = (date) => {
            return new Intl.DateTimeFormat('nl-NL', {
                day: 'numeric',
                month: 'short',
                year: 'numeric' // Added year
            }).format(date);
        };

        // --- Render Functions ---

        function getStatusIconHtml(id, type, status) {
            let icon = `<div class="w-2 h-2 rounded-full bg-blue-200"></div>`;
            let colorClass = "text-blue-200";

            if (type === 'task') {
                if (status === 'open') icon = `<div class="w-2 h-2 rounded-full bg-blue-200"></div>`;
                else if (status === 'completed') {
                    icon = `<i data-lucide="x" class="w-5 h-5"></i>`;
                    colorClass = "text-green-400";
                }
                else if (status === 'migrated') {
                    icon = `<i data-lucide="chevron-right" class="w-5 h-5"></i>`;
                    colorClass = "text-purple-400";
                }
                else if (status === 'cancelled') {
                    icon = `<div class="relative w-4 h-px bg-slate-400 rotate-0"></div>`;
                    colorClass = "text-red-400";
                }
            } else if (type === 'event') {
                icon = `<i data-lucide="circle" class="w-4 h-4"></i>`;
            } else if (type === 'note') {
                icon = `<i data-lucide="minus" class="w-4 h-4"></i>`;
            }

            return `<button onclick="handleStatusClick(event, '${id}')" 
                class="w-10 h-10 flex items-center justify-center hover:bg-white/10 rounded-full transition-colors ${colorClass}">
                ${icon}
            </button>`;
        }

        function renderEntries() {
            const listContainer = document.getElementById('entries-list');
            const emptyState = document.getElementById('empty-state');

            emptyState.classList.add('hidden');
            emptyState.classList.remove('flex');
            listContainer.classList.add('hidden');

            // 1. Filter by Status
            let result = [...state.entries];
            if (state.filterStatus === 'todo') {
                result = result.filter(e => e.status === 'open');
            }

            // 2. Filter by Type (New)
            if (state.filterType !== 'all') {
                result = result.filter(e => e.type === state.filterType);
            }

            // 3. Sort (Updated)
            result.sort((a, b) => {
                const dateA = new Date(a.targetDate).getTime() || 0;
                const dateB = new Date(b.targetDate).getTime() || 0;

                if (state.sortMode === 'priority') {
                    // Priority Sort: Important first, then date
                    if (a.isImportant && !b.isImportant) return -1;
                    if (!a.isImportant && b.isImportant) return 1;
                    return dateA - dateB; 
                } else {
                    // Date Sort: Date only
                    return dateA - dateB;
                }
            });

            if (result.length === 0) {
                emptyState.classList.remove('hidden');
                emptyState.classList.add('flex');
            } else {
                listContainer.classList.remove('hidden');
            }

            let html = '<div class="space-y-1">';

            result.forEach(entry => {
                const isEditing = state.editingId === entry.id;
                const isImportant = entry.isImportant;
                const isCompleted = entry.status === 'completed';
                const isCancelled = entry.status === 'cancelled';
                
                const bgClass = isEditing ? 'bg-slate-800 shadow-xl p-4 z-20 scale-[1.02] ring-1 ring-blue-500' : 
                                (isImportant ? 'bg-yellow-900/10 border border-yellow-600/20' : 'bg-[#1E293B] border border-transparent');
                
                const opacityClass = (!isEditing && (isCompleted || isCancelled)) ? 'opacity-50' : '';

                html += `<div id="entry-${entry.id}" class="group relative rounded-xl transition-all ${bgClass} ${opacityClass} flex items-start gap-2 p-2 -mx-2">`;
                
                if (isEditing) {
                    html += `
                    <div class="w-full space-y-3">
                        <div class="flex justify-between items-center">
                            <span class="text-xs font-bold text-blue-300 uppercase">Bewerken</span>
                            <button onclick="cancelEdit()" class="p-1 text-slate-400 hover:text-white rounded-full hover:bg-slate-700">
                                <i data-lucide="x-circle" class="w-5 h-5"></i>
                            </button>
                        </div>
                        <input type="text" id="edit-text" value="${state.editForm.text}" class="w-full p-2 text-lg border-b border-slate-600 focus:border-blue-400 focus:outline-none bg-transparent text-white" autofocus>
                        <div class="flex gap-2">
                            <input type="date" id="edit-date" value="${state.editForm.date}" class="flex-1 p-2 bg-slate-700 border border-slate-600 rounded-lg text-sm text-white focus:border-blue-400 outline-none">
                            <div class="relative flex-1">
                                <select id="edit-type" class="w-full p-2 appearance-none bg-slate-700 border border-slate-600 rounded-lg text-sm text-white focus:border-blue-400 outline-none">
                                    <option value="task" ${state.editForm.type === 'task' ? 'selected' : ''}>Taak</option>
                                    <option value="event" ${state.editForm.type === 'event' ? 'selected' : ''}>Evenement</option>
                                    <option value="note" ${state.editForm.type === 'note' ? 'selected' : ''}>Notitie</option>
                                </select>
                                <div class="absolute right-3 top-1/2 -translate-y-1/2 pointer-events-none text-slate-400">â–¼</div>
                            </div>
                        </div>
                        <button onclick="saveEdit('${entry.id}')" class="w-full py-2 bg-blue-600 hover:bg-blue-500 text-white rounded-xl font-bold flex items-center justify-center gap-2">
                            <i data-lucide="check" class="w-5 h-5"></i> Opslaan
                        </button>
                    </div>`;
                } else {
                    html += `
                    <div class="mt-0.5 shrink-0" onclick="toggleEntryStatus('${entry.id}')">
                        ${getStatusIconHtml(entry.id, entry.type, entry.status)}
                    </div>
                    <div class="flex-1 min-w-0 pt-2 cursor-pointer touch-manipulation" onclick="toggleEntryStatus('${entry.id}')">
                        <p class="text-lg leading-snug break-words ${isCancelled ? 'line-through text-slate-500' : 'text-slate-200'} ${isImportant ? 'font-bold text-yellow-100' : ''}">
                            ${entry.text}
                        </p>
                    </div>
                    
                    <!-- Date Display with Year -->
                    <div class="shrink-0 self-center px-2">
                        <span class="text-[10px] text-slate-500 font-bold uppercase tracking-wider">
                            ${formatEntryDate(entry.targetDate)}
                        </span>
                    </div>

                    <div class="flex items-center gap-1 pl-1">
                        <button onclick="toggleImportance(event, '${entry.id}')" class="p-1.5 rounded-full transition-colors ${isImportant ? 'text-yellow-400' : 'text-slate-600 hover:text-yellow-200'}">
                            <i data-lucide="star" class="w-4 h-4 ${isImportant ? 'fill-yellow-500' : ''}"></i>
                        </button>
                        <button onclick="startEdit(event, '${entry.id}')" class="p-1.5 text-slate-600 hover:text-blue-400 rounded-full">
                            <i data-lucide="edit-2" class="w-4 h-4"></i>
                        </button>
                        <button onclick="deleteEntry(event, '${entry.id}')" class="p-1.5 text-slate-600 hover:text-red-400 rounded-full">
                            <i data-lucide="trash-2" class="w-4 h-4"></i>
                        </button>
                    </div>
                    `;
                }
                html += `</div>`;
            });
            html += `</div>`;
            
            listContainer.innerHTML = html;
            refreshIcons();
        }

        function renderStats() {
            const total = state.entries.filter(e => e.type === 'task').length;
            const completed = state.entries.filter(e => e.type === 'task' && e.status === 'completed').length;
            const progress = total === 0 ? 0 : Math.round((completed / total) * 100);

            document.getElementById('progress-text').innerText = `${progress}%`;
            document.getElementById('progress-bar').style.width = `${progress}%`;
        }

        function renderControls() {
            // Update Status Filter Buttons
            const allStatusBtn = document.getElementById('btn-status-all');
            const todoStatusBtn = document.getElementById('btn-status-todo');
            
            if (state.filterStatus === 'all') {
                allStatusBtn.className = "px-3 py-1 rounded-md text-sm transition-colors bg-blue-600 text-white shadow";
                todoStatusBtn.className = "px-3 py-1 rounded-md text-sm transition-colors text-slate-400 hover:text-slate-200";
            } else {
                allStatusBtn.className = "px-3 py-1 rounded-md text-sm transition-colors text-slate-400 hover:text-slate-200";
                todoStatusBtn.className = "px-3 py-1 rounded-md text-sm transition-colors bg-blue-600 text-white shadow";
            }

            // Update Type Filter Buttons
            const typeBtns = {
                'all': document.getElementById('btn-type-all'),
                'task': document.getElementById('btn-type-task'),
                'event': document.getElementById('btn-type-event'),
                'note': document.getElementById('btn-type-note')
            };

            const activeTypeClass = "flex items-center gap-1 px-3 py-1.5 rounded-lg text-xs font-bold uppercase tracking-wider bg-blue-900/40 text-blue-200 border border-blue-700/50 whitespace-nowrap shadow-sm";
            const inactiveTypeClass = "flex items-center gap-1 px-3 py-1.5 rounded-lg text-xs font-bold uppercase tracking-wider bg-slate-800 text-slate-400 border border-slate-700 hover:bg-slate-700 whitespace-nowrap";

            for (const [type, btn] of Object.entries(typeBtns)) {
                if (state.filterType === type) {
                    btn.className = activeTypeClass;
                } else {
                    btn.className = inactiveTypeClass;
                }
            }

            // Update Sort Buttons
            const sortDateBtn = document.getElementById('btn-sort-date');
            const sortPriorityBtn = document.getElementById('btn-sort-priority');
            
            if (state.sortMode === 'priority') {
                sortPriorityBtn.className = "p-1.5 rounded-md transition-colors text-yellow-400 bg-slate-700 shadow";
                sortDateBtn.className = "p-1.5 rounded-md transition-colors text-slate-400 hover:text-white";
            } else {
                sortDateBtn.className = "p-1.5 rounded-md transition-colors text-blue-400 bg-slate-700 shadow";
                sortPriorityBtn.className = "p-1.5 rounded-md transition-colors text-slate-400 hover:text-white";
            }
        }

        // --- Logic Handlers ---

        window.setFilterStatus = (status) => {
            state.filterStatus = status;
            renderControls();
            renderEntries();
        };

        window.setFilterType = (type) => {
            state.filterType = type;
            renderControls();
            renderEntries();
        };

        window.setSortMode = (mode) => {
            state.sortMode = mode;
            renderControls();
            renderEntries();
        };

        window.toggleLegend = (show) => {
            const modal = document.getElementById('legend-modal');
            if (show) modal.classList.remove('hidden');
            else modal.classList.add('hidden');
        };

        window.handleStatusClick = (e, id) => {
            e.stopPropagation();
            toggleEntryStatus(id);
        };

        window.toggleEntryStatus = (id) => {
            const entryIndex = state.entries.findIndex(e => e.id === id);
            if (entryIndex === -1) return;
            const entry = state.entries[entryIndex];

            let newStatus = 'open';
            if (entry.type === 'task') {
                if (entry.status === 'open') newStatus = 'completed';
                else newStatus = 'open';
            } else {
                newStatus = entry.status === 'open' ? 'completed' : 'open';
            }

            state.entries[entryIndex].status = newStatus;
            saveData();
            renderEntries();
        };

        window.toggleImportance = (e, id) => {
            e.stopPropagation();
            const entryIndex = state.entries.findIndex(e => e.id === id);
            if (entryIndex === -1) return;
            
            state.entries[entryIndex].isImportant = !state.entries[entryIndex].isImportant;
            saveData();
            renderEntries();
        };

        window.deleteEntry = (e, id) => {
            e.stopPropagation();
            if (!window.confirm("Weet je zeker dat je dit wilt verwijderen?")) return;
            
            state.entries = state.entries.filter(e => e.id !== id);
            saveData();
            renderEntries();
        };

        // --- Edit Logic ---

        window.startEdit = (e, id) => {
            e.stopPropagation();
            const entry = state.entries.find(e => e.id === id);
            if (!entry) return;

            state.editingId = id;
            state.editForm = {
                text: entry.text,
                type: entry.type,
                date: entry.targetDate ? dateToInputString(entry.targetDate) : dateToInputString(new Date())
            };
            renderEntries();
        };

        window.cancelEdit = () => {
            state.editingId = null;
            renderEntries();
        };

        window.saveEdit = (id) => {
            const text = document.getElementById('edit-text').value;
            const dateStr = document.getElementById('edit-date').value;
            const type = document.getElementById('edit-type').value;

            const entryIndex = state.entries.findIndex(e => e.id === id);
            if (entryIndex === -1) return;

            state.entries[entryIndex] = {
                ...state.entries[entryIndex],
                text: text,
                type: type,
                targetDate: new Date(dateStr)
            };

            state.editingId = null;
            saveData();
            renderEntries();
        };

        // --- Add Logic ---

        document.getElementById('input-text').addEventListener('input', (e) => {
            const btn = document.getElementById('btn-submit');
            if (e.target.value.trim()) btn.removeAttribute('disabled');
            else btn.setAttribute('disabled', 'true');
        });

        // Set default date
        document.getElementById('input-date').value = dateToInputString(new Date());

        document.getElementById('add-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const textInput = document.getElementById('input-text');
            const dateInput = document.getElementById('input-date');
            const typeRadios = document.getElementsByName('entryType');
            let selectedType = 'task';
            for (const radio of typeRadios) {
                if (radio.checked) { selectedType = radio.value; break; }
            }

            if (!textInput.value.trim()) return;

            const newEntry = {
                id: crypto.randomUUID(), // Local unique ID
                text: textInput.value,
                type: selectedType,
                status: 'open',
                createdAt: new Date(),
                targetDate: new Date(dateInput.value),
                isImportant: false
            };

            state.entries.push(newEntry);
            saveData();
            renderEntries();

            textInput.value = '';
            document.getElementById('btn-submit').setAttribute('disabled', 'true');
        });

        window.updateTypeSelection = () => {
            // Visual logic handled by CSS
        };

        // --- Initialization ---
        
        loadData();
        renderControls(); // Initial controls render
        renderEntries();
        renderStats();
        refreshIcons();

    </script>
</body>
</html>
